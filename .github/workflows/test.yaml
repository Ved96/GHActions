name: KICS Scan and Terraform Format Check

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  kics-scan-and-format:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 1: Install KICS
      - name: Install KICS
        run: curl -sSfL https://get.kics.io | sh
      - name: Copy .tfvars files
        run: |
          cp -r project-folder/*.tfvars module-folder/
      - name: Run KICS Scan
        id: kics-scan
        run: kics scan -p module-folder/
      - name: Delete .tfvars files
        if: ${{ steps.kics-scan.outcome == 'success' }}
        run: rm module-folder/*.tfvars
      - name: Set PR status to "failure" on Terraform formatting failure
        if: ${{ steps.terraform-fmt.outcome == 'failure' }}
        run: |
          echo "Terraform formatting check failed. Please format your Terraform code using 'terraform fmt' and push the changes."
          exit 1
